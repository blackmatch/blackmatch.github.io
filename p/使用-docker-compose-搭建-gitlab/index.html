<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="前言 前段时间，我写了一篇《 使用 Gogs 搭建自己的 Git 服务 》，结果大家都不太看好 Gogs，我在使用 Gogs 几天后，感觉是：搭建简单，对性能要求不高。也正因为简单和消耗资源少， Gogs 慢慢的无法满足日益复杂的 DevOps 需求，比如 CI/CD （ continuous integration and continuous delivery，持续集成和持续交付）、性能问题等。对于 Gogs 和 gitlab 我不作评论，这里有一篇来自 gitlab 官网相当于竞品分析的文章：https://about.gitlab.com/comparison/gogs-vs-gitlab.html。本文主要介绍如何使用 docker-compose 搭建 gitlab 。\n"><title>使用 docker-compose 搭建 gitlab</title>
<link rel=canonical href=https://www.blackmatch.cn/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content=" 使用 docker-compose 搭建 gitlab"><meta property='og:description' content="前言 前段时间，我写了一篇《 使用 Gogs 搭建自己的 Git 服务 》，结果大家都不太看好 Gogs，我在使用 Gogs 几天后，感觉是：搭建简单，对性能要求不高。也正因为简单和消耗资源少， Gogs 慢慢的无法满足日益复杂的 DevOps 需求，比如 CI/CD （ continuous integration and continuous delivery，持续集成和持续交付）、性能问题等。对于 Gogs 和 gitlab 我不作评论，这里有一篇来自 gitlab 官网相当于竞品分析的文章：https://about.gitlab.com/comparison/gogs-vs-gitlab.html。本文主要介绍如何使用 docker-compose 搭建 gitlab 。\n"><meta property='og:url' content='https://www.blackmatch.cn/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/'><meta property='og:site_name' content='blackmatch 的个人博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Git'><meta property='article:published_time' content='2018-10-03T21:40:04+08:00'><meta property='article:modified_time' content='2018-10-03T21:40:04+08:00'><meta name=twitter:title content=" 使用 docker-compose 搭建 gitlab"><meta name=twitter:description content="前言 前段时间，我写了一篇《 使用 Gogs 搭建自己的 Git 服务 》，结果大家都不太看好 Gogs，我在使用 Gogs 几天后，感觉是：搭建简单，对性能要求不高。也正因为简单和消耗资源少， Gogs 慢慢的无法满足日益复杂的 DevOps 需求，比如 CI/CD （ continuous integration and continuous delivery，持续集成和持续交付）、性能问题等。对于 Gogs 和 gitlab 我不作评论，这里有一篇来自 gitlab 官网相当于竞品分析的文章：https://about.gitlab.com/comparison/gogs-vs-gitlab.html。本文主要介绍如何使用 docker-compose 搭建 gitlab 。\n"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_9476e4a6865a8508.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>blackmatch 的个人博客</a></h1><h2 class=site-description>须知少日拏云志，曾许人间第一流。</h2></div></header><ol class=menu-social><li><a href=https://github.com/blackmatch target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#准备工作>准备工作</a></li><li><a href=#先让-gitlab-跑起来>先让 gitlab 跑起来</a></li><li><a href=#开启邮件服务>开启邮件服务</a></li><li><a href=#安装-git-runner>安装 git-runner</a></li><li><a href=#测试-cicd>测试 CI/CD</a></li><li><a href=#完整的配置>完整的配置</a></li><li><a href=#其他需要注意的问题>其他需要注意的问题</a></li><li><a href=#参考资料>参考资料</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/devops/>DevOps</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/>使用 docker-compose 搭建 gitlab</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2018-10-03</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div></footer></div></header><section class=article-content><h2 id=前言>前言</h2><p>前段时间，我写了一篇《<span data-type=color style=color:#333><span data-type=background style=background-color:#fff> 使用 Gogs 搭建自己的 Git 服务 </span></span>》，结果大家都不太看好 Gogs，我在使用 Gogs 几天后，感觉是：搭建简单，对性能要求不高。也正因为简单和消耗资源少， Gogs 慢慢的无法满足日益复杂的 DevOps 需求，比如 <code>CI/CD</code> （ continuous integration and continuous delivery，持续集成和持续交付）、性能问题等。对于 <code>Gogs</code> 和 <code>gitlab</code> 我不作评论，这里有一篇来自 gitlab 官网相当于竞品分析的文章：<a class=link href=https://about.gitlab.com/comparison/gogs-vs-gitlab.html target=_blank rel=noopener>https://about.gitlab.com/comparison/gogs-vs-gitlab.html</a>。本文主要介绍如何使用 <code>docker-compose</code> 搭建 <code>gitlab</code> 。</p><h2 id=准备工作>准备工作</h2><p>关于使用 docker/docker-compose 搭建 gitlab，其实有很多教程了，官方也有相应的介绍。但是，我搜到的很多教程使用的 docker 镜像是来自民间大牛的开源镜像：<a class=link href=https://github.com/sameersbn/docker-gitlab target=_blank rel=noopener>https://github.com/sameersbn/docker-gitlab</a>，对于有点强迫症的我来说，既然 gitlab 官方提供了镜像，为何不用官方的呢？其次就是， gitlab 官方关于使用 docker-compose 搭建 gitlab 的描述篇幅较少，一些细节问题需要自己实践后才会遇到。下面一步一步介绍我的折腾过程，就当是自己的学习笔记吧。官方的教程在这里：<a class=link href=https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose target=_blank rel=noopener>https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose</a>。在开始之前，先介绍一下我的装备（穷不是我的错。。。）：</p><ul><li>一台 2012 年买的华硕笔记本，露个脸吧：</li></ul><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/11.png width=539 height=719 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/11_hu_64194efac9bedf9e.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/11_hu_4fad048585ca4d31.png 1024w" loading=lazy alt=11 class=gallery-image data-flex-grow=74 data-flex-basis=179px></p><p>这台笔记本是我读大学用的『战机』，被我花巨资改造了一下：内存加到了 8G，换上一个 128G 的固态硬盘。这个笔记本在我读大学的时候已经被折腾过好多次了，自从毕业后就很少用了，所以拿出来在家里当服务器用，装了 win10 、 VirtualBox，然后装了一个 Ubuntu18.04.1 的虚拟机，分了 4G 内存、 40G 硬盘，安装好 docker、 docker-compose。</p><ul><li>一台低配版 Mac mini。 8G 内存、 1T 硬盘，用终端连接 Ubuntu 服务器。题外话：直接在我的 Mac mini 上搭建 gitlab，发现有点带不起来，可能是因为我装了太多软件了。</li></ul><p>硬件就这两台电脑，云服务器目前是买不起的，也没有必要。下面开始折腾吧。</p><h2 id=先让-gitlab-跑起来>先让 gitlab 跑起来</h2><p>在 Ubuntu 服务器上拉取 gitlab-ce 官方镜像：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>docker</span> <span class=n>pull</span> <span class=n>gitlab</span><span class=p>/</span><span class=nb>gitlab-ce</span><span class=err>:</span><span class=mf>11.3</span><span class=p>.</span><span class=mf>1</span><span class=n>-ce</span><span class=p>.</span><span class=py>0</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意：我使用的 tag 是 <code>11.3.1-ce.0</code></p></blockquote><p>新建一个 <code>docker-compose.yml</code> 文件，写入如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;gitlab/gitlab-ce:11.3.1-ce.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>gitlab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        external_url &#39;http://git.blackmatch.cn&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;80:80&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;443:443&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;33:22&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/config:/etc/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/logs:/var/log/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/data:/var/opt/gitlab&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>保存文件，在该文件目录下执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>docker-compose</span> <span class=n>up</span>
</span></span></code></pre></td></tr></table></div></div><p>然后会看到终端上刷刷刷 ~~~ 滚动很多内容，耐心等待一会（我这里大概 3 分钟左右），然后在我的 Mac mini 的浏览器上访问 <code>http://git.blackmatch.cn</code> （我事先已经将域名和 Ubuntu 服务器的 IP 做了 hosts 映射），看到如下界面：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/22.png width=1067 height=573 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/22_hu_6e395287b1d52e08.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/22_hu_d64e77a25d433d92.png 1024w" loading=lazy alt=22 class=gallery-image data-flex-grow=186 data-flex-basis=446px></p><p>看到这个界面说明 gitlab 已经成功跑起来了，可以在这个界面设置 <code>root</code> 账号的密码，然后使用 <code>root</code> 账号登录系统：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/33.png width=1011 height=493 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/33_hu_aa4bd8d35de97539.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/33_hu_8efb76ceed5977ca.png 1024w" loading=lazy alt=33 class=gallery-image data-flex-grow=205 data-flex-basis=492px></p><p>登录成功后的界面是这样的：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/44.png width=1570 height=659 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/44_hu_ca7d31527cdbe0b5.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/44_hu_b997910466a059c1.png 1024w" loading=lazy alt=44 class=gallery-image data-flex-grow=238 data-flex-basis=571px></p><p>我来创建一个项目看看：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/55.png width=1584 height=740 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/55_hu_99054483d114d49b.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/55_hu_c6b512c0854e004.png 1024w" loading=lazy alt=55 class=gallery-image data-flex-grow=214 data-flex-basis=513px></p><p>这个新建项目的 <code>HTTP</code> 地址为：<a class=link href=http://git.blackmatch.cn/root/test.git target=_blank rel=noopener>http://git.blackmatch.cn/root/test.git</a>，这里顺带提一下，这里的地址中的 <code>git.blackmatch.cn</code> 就是我在 <code>docker-compose.yml</code> 文件中配置的环境变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        external_url &#39;http://git.blackmatch.cn&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里的 <code>external_url</code> 配置的是外部 URL，会影响项目的访问地址，如果不配置，项目的访问地址会是一个随机字符串，在云服务器上搭建时尤其要注意这一点。</p><h2 id=开启邮件服务>开启邮件服务</h2><p>我们在使用 <code>github</code> 等类似的平台工具的时候都会用到邮件服务，比如你在 <code>github</code> 上进行注册、密码重置、有人给你的开源项目提 issue 等等的时候，你通常都会收到邮件提醒。 <code>gitlab</code> 肯定也会有这个功能的，下面我们就来开启这个功能，在此之前需要准备一个邮箱账号，这个账号是用来负责发送邮件的，需要开启 <code>smtp</code> 协议支持。使用 <code>CTRL</code> + <code>C</code> 快捷键停止正在运行中的 gitlab 容器，然后修改 <code>docker-compose.yml</code> 为如下内容（这里以 gmail 邮箱为例）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;gitlab/gitlab-ce:11.3.1-ce.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>gitlab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        external_url &#39;http://git.blackmatch.cn&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        # email setting
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_enable&#39;] = true
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_address&#39;] = &#34;smtp.gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_port&#39;] = 587
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_user_name&#39;] = &#34;my.email@gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_password&#39;] = &#34;my-gmail-password&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_domain&#39;] = &#34;smtp.gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_authentication&#39;] = &#34;login&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = true
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_tls&#39;] = false
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_openssl_verify_mode&#39;] = &#39;peer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;80:80&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;443:443&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;33:22&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/config:/etc/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/logs:/var/log/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/data:/var/opt/gitlab&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>将配置中的 <code>my.email@gmail.com</code> 和 <code>my-gmail-password</code> 替换为你自己的邮箱和密码，记得一定要开启邮箱的 <code>smtp</code> 协议服务，否则无法发送邮件。其他邮箱的配置方式大同小异，详细的介绍可以看这里：<a class=link href=https://docs.gitlab.com/omnibus/settings/smtp.html target=_blank rel=noopener>https://docs.gitlab.com/omnibus/settings/smtp.html</a>。保存配置文件，然后执行 <code>docker-compose up</code> ，然后使用 <code>root</code> 账号登录 gitlab，新建一个账户（注意正确填写新建账户的邮箱地址），新建账户成功后，会给新账户的邮箱发送一封邮件，如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/66.png width=666 height=470 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/66_hu_f7be5628a8ebaf4e.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/66_hu_6bd8762c144bb895.png 1024w" loading=lazy alt=66 class=gallery-image data-flex-grow=141 data-flex-basis=340px></p><p>至此，邮件服务已成功启用。</p><h2 id=安装-git-runner>安装 git-runner</h2><p>前面我提到， gitlab 支持 CI/CD，如果我们需要对某个项目进行持续集成 / 持续交付，则需要给该项目配置一些任务，当我们每次 push 代码的时候，自动触发这些预先配置好的任务，而这些任务的执行者就是 gitlab-runner。可以简单的概括一下 gitlab 和 gitlab-runner 的关系： gitlab 在监测到有代码提交时，通知 gitlab-runner 去执行一些任务， gitlab-runner 执行完这些任务后将执行的结果反馈给 gitlab。所以，如果要开启 CI/CD，需要先完成两件事： 1. 在服务器上安装好 gitlab-runner； 2. 注册 gitlab-runner，打通 gitlab 和 gitlab-runner 之间的交互。在服务器上安装 gitlab-runner 的步骤如下：</p><ul><li>下载二进制安装包</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=nb>wget </span><span class=n>-O</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>local</span><span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=nb>gitlab-runner</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=nb>gitlab-runner</span><span class=n>-downloads</span><span class=p>.</span><span class=py>s3</span><span class=p>.</span><span class=py>amazonaws</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>latest</span><span class=p>/</span><span class=n>binaries</span><span class=p>/</span><span class=nb>gitlab-runner</span><span class=n>-linux-amd64</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>修改权限：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=n>chmod</span> <span class=p>+</span><span class=n>x</span> <span class=p>/</span><span class=n>usr</span><span class=p>/</span><span class=n>local</span><span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=nb>gitlab-runner</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>在服务器上新增一个用户（ gitlab-runner），专门用于执行 CI/CD 任务：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=n>useradd</span> <span class=p>-</span><span class=n>-comment</span> <span class=s1>&#39;GitLab Runner&#39;</span> <span class=p>-</span><span class=n>-create-home</span> <span class=nb>gitlab-runner</span> <span class=p>-</span><span class=n>-shell</span> <span class=p>/</span><span class=n>bin</span><span class=p>/</span><span class=n>bash</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>执行安装：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=nb>gitlab-runner</span> <span class=n>install</span> <span class=p>-</span><span class=n>-user</span><span class=p>=</span><span class=nb>gitlab-runner</span> <span class=p>-</span><span class=n>-working-directory</span><span class=p>=/</span><span class=n>home</span><span class=p>/</span><span class=nb>gitlab-runner</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>启动 gitlab-runner：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=nb>gitlab-runner</span> <span class=nb>start
</span></span></span></code></pre></td></tr></table></div></div><p>接下来就是注册 gitlab-runner，只有注册之后 gitlab 和 gitlab-runner 之间才能交互。使用 <code>root</code> 账号登录 gitlab 之后，在路由 <code>/admin/runners</code> 下可以看到注册 gitlab-runner 需要用到的 <code>URL</code> 和 <code>token</code> 。如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/77.png width=1150 height=792 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/77_hu_efbd51ca2cffc714.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/77_hu_9b4178fffac13f5f.png 1024w" loading=lazy alt=77 class=gallery-image data-flex-grow=145 data-flex-basis=348px></p><p>在服务器上执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>sudo</span> <span class=nb>gitlab-runner</span> <span class=n>register</span>
</span></span></code></pre></td></tr></table></div></div><p>然后根据提示输入 <code>URL</code> 和 <code>token</code> 等信息就可以了，过程如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/88.png width=915 height=261 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/88_hu_5af6dbaebf18fdc9.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/88_hu_66f54dc4e653a23e.png 1024w" loading=lazy alt=88 class=gallery-image data-flex-grow=350 data-flex-basis=841px></p><p>好吧。。。报错了，这个可能是我的 <code>URL</code> 是域名，但是服务器没有配置 <code>hosts</code> ，故在服务器上无法通过域名访问 gitlab，修改一下服务器的 <code>/etc/hosts</code> 文件，重新注册一下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/99.png width=914 height=291 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/99_hu_1a2f87be719f1783.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/99_hu_849814fdfc771bac.png 1024w" loading=lazy alt=99 class=gallery-image data-flex-grow=314 data-flex-basis=753px></p><p>这回注册成功了，需要注意的是，在注册 gitlab-runner 的时候，需要选择一个或者多个执行器（ executor），不同的执行器有不同的特性和功能，如果你不知道怎么选择，可以先看看这里：<a class=link href=https://docs.gitlab.com/runner/executors/README.html#i-am-not-sure target=_blank rel=noopener>https://docs.gitlab.com/runner/executors/README.html#i-am-not-sure</a>。我这里选择了最简单的 <code>shell</code> 执行器，<code>shell</code> 执行器可以让 gitlab-runner 在执行任务的时候直接使用 shell 命令，但是如果用到一些构建工具，必须事先在服务器上安装这些工具，例如：在代码提交后通知 gitlab-runner 执行 <code>npm run build</code> 命令来构建项目，则需要事先在服务器上安装 <code>npm</code> 。 gitlab-runner 注册成功后，刷新一下网页，会看到多了一个 runner：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/110.png width=1566 height=795 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/110_hu_6dba18b8904deb4c.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/110_hu_beb2d2fee00951cd.png 1024w" loading=lazy alt=110 class=gallery-image data-flex-grow=196 data-flex-basis=472px></p><p>这样我们就可以使用这个 runner 为我们执行任务了，这里需要注意的是，新创建的 runner，默认情况下，只对打 <code>tag</code> 的 <code>commit</code> 触发任务，如果想要每一次提交代码都执行，则需要修改 runner 的配置，如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/111.png width=960 height=736 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/111_hu_f167d6e61e31f084.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/111_hu_9f6ae49efc12006d.png 1024w" loading=lazy alt=111 class=gallery-image data-flex-grow=130 data-flex-basis=313px></p><p>至此， gitlab-runner 就已开启成功了，可以对项目进行 CI/CD 配置了。</p><h2 id=测试-cicd>测试 CI/CD</h2><p>经过前面的部署，目前我搭建的 gitlab 已经可以使用 CI 功能了，这里我简单的测试一下这个功能，前面我们已经使用 <code>root</code> 用户创建了一个 <code>test</code> 项目，将这个项目 <code>clone</code> 到我的 Mac mini 电脑上，然后在项目根目录下分别创建 <code>app.js</code> 和 <code>.gitlab-ci.yml</code> 这两个文件，要启用 gitlab 的 CI 功能，除了需要正配安装并配置好 gitlab-runner 外，还需要在每个项目的根目录下创建一个名为 <code>.gitlab-ci.yml</code> 文件，并在这个文件下配置具体的任务，例如我们可以简单的测试一下 gitlab-runner 是否能正常运行， <code>.gitlab-ci.yml</code> 文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>release</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cp ./app.js /home/gitlab-runner/release</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里就设置一个很简单的任务：将项目中的 <code>app.js</code> 文件拷贝到服务器的 <code>/home/gitlab-runner/release</code> 目录下。在我的 Mac mini 上对 <code>test</code> 项目修改的内容提交到服务器，会触发 gitlab-runner 执行任务，结果如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/112.png width=1362 height=475 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/112_hu_29d6a5c637bf6ec8.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/112_hu_c6b0d3e9987b9a96.png 1024w" loading=lazy alt=112 class=gallery-image data-flex-grow=286 data-flex-basis=688px></p><p>需要注意的是， gitlab-runner 在服务器上执行每个项目预先配置的任务的时候是以 <code>gitlab-runner</code> 用户的身份执行，所以要注意权限的问题，我第一次提交的时候，因为 <code>release</code> 目录是我用服务器的 <code>root</code> 权限创建的，所以 <code>gitlab-runner</code> 用户没有权限将文件复制到该目录下，修改目录所有者后，第二次提交就成功了，如下：</p><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/113.png width=1065 height=451 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/113_hu_dee120ffbc79a33f.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/113_hu_c0c1cc3cba96dd8c.png 1024w" loading=lazy alt=113 class=gallery-image data-flex-grow=236 data-flex-basis=566px></p><p>至此， gitlab-runner 执行 CI 任务就测试成功了。当然这只是一个很简单的测试， gitlab 还有很多关于 CI/CD、 Auto DevOps 等方面的功能特性，对持续集成、持续交付、提升项目质量等方面都有很大的帮助，大家感兴趣可以多去尝试。</p><h2 id=完整的配置>完整的配置</h2><p>经过上面的配置和调试，目前的 gitlab 已经能满足开发工作流中一些常用的需求，如果没有其他需求，可以直接把该容器投入到生产中，完整的 <code>docker-compose.yml</code> 文件内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;gitlab/gitlab-ce:11.3.1-ce.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>gitlab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>GITLAB_OMNIBUS_CONFIG</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        external_url &#39;http://git.blackmatch.cn&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        # email setting
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_enable&#39;] = true
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_address&#39;] = &#34;smtp.gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_port&#39;] = 587
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_user_name&#39;] = &#34;my.email@gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_password&#39;] = &#34;my-gmail-password&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_domain&#39;] = &#34;smtp.gmail.com&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_authentication&#39;] = &#34;login&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = true
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_tls&#39;] = false
</span></span></span><span class=line><span class=cl><span class=sd>        gitlab_rails[&#39;smtp_openssl_verify_mode&#39;] = &#39;peer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;80:80&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;443:443&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;33:22&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/config:/etc/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/logs:/var/log/gitlab&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;./srv/gitlab/data:/var/opt/gitlab&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>保存文件后，使用如下命令启动容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>docker-compose</span> <span class=n>up</span> <span class=n>-d</span>
</span></span></code></pre></td></tr></table></div></div><p>至此， gitlab 已成功部署。</p><h2 id=其他需要注意的问题>其他需要注意的问题</h2><ul><li>gitlab 对服务器的性能要求较高，至少要保证有 4G 的内存，否则很容易出现各种奇怪的问题，比如网页 502 等。</li><li>gitlab-runner 在执行任务的时候不对你的项目做任何修改，因为其原理是：先把项目所有内容 <code>fetch</code> （默认）或者 <code>clone</code> 到 <code>/home/gitlab-runner</code> 目录下，然后再执行相关的任务操作，不会对你的项目做任何修改。</li><li>每次修改完 <code>docker-compose.yml</code> 文件后，重新启动容器可能会花费较多的时间，请耐心等待。</li><li>汉化问题，可能较老的 gitlab-ce 版本需要专门下载一个中文包来做汉化，现在只需要在账户登录后，在账户设置中将 <code>Preferred language</code> 设置成 <code>简体中文</code> 即可，保存设置后刷新界面，效果如下：</li></ul><p><img src=/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/114.png width=1375 height=890 srcset="/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/114_hu_24649a134e7e7d8a.png 480w, /p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/114_hu_c979dd7abfca7e49.png 1024w" loading=lazy alt=114 class=gallery-image data-flex-grow=154 data-flex-basis=370px></p><h2 id=参考资料>参考资料</h2><p><a class=link href=https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose target=_blank rel=noopener>https://docs.gitlab.com/omnibus/docker/#install-gitlab-using-docker-compose</a></p><p><a class=link href=https://docs.gitlab.com/runner/ target=_blank rel=noopener>https://docs.gitlab.com/runner/</a></p><p><a class=link href=https://www.jianshu.com/p/2b43151fb92e target=_blank rel=noopener>https://www.jianshu.com/p/2b43151fb92e</a></p><p><a class=link href=https://docs.gitlab.com/omnibus/settings/smtp.html target=_blank rel=noopener>https://docs.gitlab.com/omnibus/settings/smtp.html</a></p><p><a class=link href=https://docs.gitlab.com/runner/executors/README.html target=_blank rel=noopener>https://docs.gitlab.com/runner/executors/README.html</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/git/>Git</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E4%BD%BF%E7%94%A8-gogs-%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84-git-%E6%9C%8D%E5%8A%A1/><div class=article-details><h2 class=article-title>使用 Gogs 搭建自己的 Git 服务</h2></div></a></article><article><a href=/p/%E5%9C%A8-linux-%E7%B3%BB%E7%BB%9F%E4%B8%8A%E9%80%9A%E8%BF%87%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85%E5%AE%89%E8%A3%85-node.js/><div class=article-details><h2 class=article-title>在 Linux 系统上通过二进制包安装 Node.js</h2></div></a></article><article><a href=/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/><div class=article-details><h2 class=article-title>开启 bbr 差点引发一场血案</h2></div></a></article><article><a href=/p/centos-%E9%80%9A%E8%BF%87-letsencrypt-%E5%AE%9E%E7%8E%B0-https/><div class=article-details><h2 class=article-title>CentOS 通过 letsencrypt 实现 HTTPS</h2></div></a></article></div></div></aside><div id=remark42></div><script>var remark_config={host:"https://remark42.blackmatch.cn",site_id:"blackmatch.cn",components:["embed"],url:"https://www.blackmatch.cn/p/%E4%BD%BF%E7%94%A8-docker-compose-%E6%90%AD%E5%BB%BA-gitlab/",max_shown_comments:15,theme:document.documentElement.dataset.scheme,page_title:" 使用 docker-compose 搭建 gitlab",locale:"zh",show_email_subscription:!0};!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document),window.addEventListener("onColorSchemeChange",e=>{window.REMARK42.changeTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 blackmatch 的个人博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>