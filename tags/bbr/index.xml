<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>BBR on blackmatch 的个人博客</title><link>https://www.blackmatch.cn/tags/bbr/</link><description>Recent content in BBR on blackmatch 的个人博客</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 28 Sep 2018 21:37:40 +0800</lastBuildDate><atom:link href="https://www.blackmatch.cn/tags/bbr/index.xml" rel="self" type="application/rss+xml"/><item><title> 开启 bbr 差点引发一场血案</title><link>https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/</link><pubDate>Fri, 28 Sep 2018 21:37:40 +0800</pubDate><guid>https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/</guid><description>&lt;h2 id="故事背景">故事背景
&lt;/h2>&lt;p>我在 vultr 上有一台 VPS，由于服务器在洛杉矶，在国内访问速度比较慢。以前有听说 Google 的 bbr 拥塞算法能够提高 tcp 的传输速度，于是想着把 bbr 打开。我的服务器环境如下：&lt;/p>
&lt;ul>
&lt;li>操作系统： CentOS7&lt;/li>
&lt;li>Linux 内核版本： 3.10.0&lt;/li>
&lt;li>SELINUX 配置： disabled&lt;/li>
&lt;li>docker 版本： 18.06.1-ce&lt;/li>
&lt;/ul>
&lt;h2 id="开启-bbr">开启 bbr
&lt;/h2>&lt;p>开启 bbr 需要先把 Linux 内核版本升级到 4.10 以上，所以首先需要升级内核。我是根据这个教程 &lt;a class="link" href="https://www.vultr.com/docs/how-to-deploy-google-bbr-on-centos-7" target="_blank" rel="noopener"
>https://www.vultr.com/docs/how-to-deploy-google-bbr-on-centos-7&lt;/a> 一步一步操作的，最后将 Linux 内核版本升级到了 4.18.9 ，最后也成功开启了 bbr，感觉访问速度稍微开了那么一点点。&lt;/p>
&lt;h2 id="docker-服务无法启动了">docker 服务无法启动了
&lt;/h2>&lt;p>开启 bbr 后发现 docker 服务起不来了，尝试过几次删掉重装，结果还是一样，排查得到如下报错：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">unable to configure the Docker daemon with file /etc/docker/daemon.json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把这个报错仍 Google，尝试了几个方案都不行。继续折腾，再根据报错信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">failed to start docker application
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续 Google，在 segmentfault 找到了这个问答：&lt;a class="link" href="https://segmentfault.com/q/1010000002392472" target="_blank" rel="noopener"
>https://segmentfault.com/q/1010000002392472&lt;/a>，感觉和我的情况很像啊。暗喜中。。。看到这个问题有好多人回答，我就从上往下一个一个试，其中有个回答是：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/11.png"
width="1726"
height="274"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/11_hu_54725add5ab8af03.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/11_hu_95a305b80b020e79.png 1024w"
loading="lazy"
alt="11"
class="gallery-image"
data-flex-grow="629"
data-flex-basis="1511px"
>&lt;/p>
&lt;p>那我就照做 :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">vim /etc/selinux/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">i
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">edit...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shutdown -r now
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>一顿操作猛如虎，然后喝口茶等待系统重启。。。等了一两分钟，使用 ssh 连接服务，突然给我来一个惊喜：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">permission denied
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="系统无法登录了">系统无法登录了
&lt;/h2>&lt;p>ssh 连不过去了，卧槽这是什么情况。因为我的服务器只有 &lt;code>root&lt;/code> 账号，我一直都是用 &lt;code>root&lt;/code> 账号登录的，想尝试其他账号也不行了。我意识到肯定是我刚才修改了 &lt;code>SELINUX&lt;/code> 配置导致，但是现在登不进去系统想改回来也不行啊。虽然我对 Linux 懂的不多，但是这个时候一定要保持冷静，继续喝一口茶。想到了找学弟帮忙，学弟是做运维的，对 Linux 特别熟，大学时候和他一起培训过几天 Linux。学弟提醒我可以去 VPS 提供商的后台管理界面看看能不能做些什么。于是我登录到 vultr，进入后台管理界面，发现有一个 &lt;code>View Console&lt;/code> 操作，如下：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/22.png"
width="766"
height="224"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/22_hu_ade921021149be4d.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/22_hu_316dfa3ff71afaa0.png 1024w"
loading="lazy"
alt="22"
class="gallery-image"
data-flex-grow="341"
data-flex-basis="820px"
>&lt;/p>
&lt;p>点击，弹出一个窗口，进入了一个 Linux 终端：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/33.png"
width="1500"
height="956"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/33_hu_593e97ca854903f9.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/33_hu_3fa831a65999cd7e.png 1024w"
loading="lazy"
alt="33"
class="gallery-image"
data-flex-grow="156"
data-flex-basis="376px"
>&lt;/p>
&lt;p>哈哈！感觉看到了希望，输入账号、密码，用力敲一下回车键，啪！提示：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">permission denied
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>什么鬼？？？结果还是一样啊！还是登不进去啊！冷静冷静。。。继续喝口茶， Google 一番尝试了一些方法，都不行。茶已经喝完啦，脾气也上来了。想着直接把系统重置了吧，反正也没有特别重要的数据。说时迟那时快，当我快要点击重置系统按钮的时候，脑子里突然闪过一个画面，就像动漫主角快要被干掉时突然开挂了一样，这个画面就是：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/44.png"
width="1500"
height="956"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/44_hu_19db5abe67204ab4.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/44_hu_2332c7fb8bb3e4f1.png 1024w"
loading="lazy"
alt="44"
class="gallery-image"
data-flex-grow="156"
data-flex-basis="376px"
>&lt;/p>
&lt;p>这个难道就是传说中的恢复模式？不管了，点一下看看，出现了这个界面：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/55.png"
width="1266"
height="716"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/55_hu_76e8bae6f9831053.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/55_hu_ce7298056cd7634a.png 1024w"
loading="lazy"
alt="55"
class="gallery-image"
data-flex-grow="176"
data-flex-basis="424px"
>&lt;/p>
&lt;p>卧槽！我感觉还能抢救一下。看个这个，感觉又看到了希望，外挂已上线 ~~ 哈哈哈。说实话，我对这个界面真的不熟，只知道这里有很多个内核，可以选择任何一个系统启动。于是问学弟，结果被学弟鄙视，让我我按照忘记密码的套路去操作，接下来又是一波搜索。经过一番倒腾，终于找到了一个可行的方案，具体操作如下：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/66.png"
width="1502"
height="866"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/66_hu_1f9d5d2c96a7f8d3.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/66_hu_5c77259a268a9d0e.png 1024w"
loading="lazy"
alt="66"
class="gallery-image"
data-flex-grow="173"
data-flex-basis="416px"
>&lt;/p>
&lt;p>选中一个内核，我这里选择的是我更新后的内核，按下键盘上的 &lt;code>e&lt;/code> 键进入编辑模式，然后使用 &lt;code>向下键&lt;/code> 一直往后翻，找到 &lt;code>rhgb quiet LANG=en_US.UTF-8&lt;/code> 在后面加上 &lt;code>enforcing=0&lt;/code> ，如下：&lt;/p>
&lt;p>&lt;img src="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/77.png"
width="1500"
height="864"
srcset="https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/77_hu_f6e280e960f28b4c.png 480w, https://www.blackmatch.cn/p/%E5%BC%80%E5%90%AF-bbr-%E5%B7%AE%E7%82%B9%E5%BC%95%E5%8F%91%E4%B8%80%E5%9C%BA%E8%A1%80%E6%A1%88/77_hu_641f41965dbdcf07.png 1024w"
loading="lazy"
alt="77"
class="gallery-image"
data-flex-grow="173"
data-flex-basis="416px"
>&lt;/p>
&lt;p>然后按下 &lt;code>Ctrl&lt;/code> + &lt;code>x&lt;/code> 启动系统，正确输入账号、密码，再次用力敲一下回车键，这次终于等进去了！！！总算是抢救回来了，然后里面修改 &lt;code>SELINUX&lt;/code> 配置，又是一顿操作猛如虎，重启之后能正常登录了，彻底好了。&lt;/p>
&lt;h2 id="docker-服务怎么办">docker 服务怎么办
&lt;/h2>&lt;p>虽然已经能够正常登录服务器了，但是 docker 还是老样子起不来。但是，在系统无法登录那一刻，我冥冥之中已经感觉到 docker 的问题应该如何解决了，因为我看到了这个回答：&lt;/p>
&lt;p>![88]({{ site.url }}/images/centos-enable-bbr/88.png)&lt;/p>
&lt;p>我的直觉向来很准的，因为读大学的时候自己经常折腾各种黑科技之类的，这种感觉我很熟悉，哈哈哈。按照这个方法操作，&lt;strong>最后 docker 服务真的好了&lt;/strong>，哈哈哈！&lt;/p>
&lt;h2 id="结束语">结束语
&lt;/h2>&lt;p>本来都已经打算重置系统了，没想到最后 bbr 成开启了， docker 服务也弄好，真是成功逆袭了啊！因为我对 Linux 不是很熟，所以大牛们可能觉得这根本不算是什么事，对我来说那可是相当惊险刺激啊！感谢学弟的耐心指导，我以后一定会努力学习 Linux 的。最后友情提示：&lt;/p>
&lt;p>&lt;strong>没事不要升级 Linux 内核！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>没事不要乱改 SELINUX 配置！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>没事不要瞎折腾！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>注意备份重要数据！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>注意备份重要数据！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>注意备份重要数据！&lt;/strong>&lt;/p></description></item></channel></rss>